name: "sync-test"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/15 10 * * *'
  workflow_dispatch:
  
jobs:
  sync-test:
    runs-on: ubuntu-latest
    steps:
      - name: Set Variable
        id: vars
        run: |
          echo ::set-output name=META_MYSQL::"mysql://root:root@\(127.0.0.1\)/sync_test"
          echo ::set-output name=MOUNT_POINT::/tmp/juicefs-sync-test/
          echo ::set-output name=BUCKET::/var/jfs/
          echo ::set-output name=NAME::sync-test
          echo ::set-output name=DUMP_FILE::meta_with_4M_Empty_files.json
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Checkout source code for test
        uses: actions/checkout@v2
        with:
          repository: juicedata/juicefs
          path: juicefs-source

      - name: Test Sync
        run: |
          sudo chmod 777 /var/ 
          meta_url=${{ steps.vars.outputs.META_MYSQL }}
          sudo /etc/init.d/mysql start
          db_name=$(basename $meta_url | awk -F? '{print $1}')
          mysql -uroot -proot -e "drop database if exists $db_name; create database $db_name;" 
          wget -q https://github.com/juicedata/juicefs/releases/download/v1.0.0-beta2/juicefs-1.0.0-beta2-linux-amd64.tar.gz
          tar -xzf juicefs-1.0.0-beta2-linux-amd64.tar.gz
          options=(
            '--include "docs/en/security/trash.md" --include "docs/zh_cn/security/trash.md" --include "pkg/vfs/accesslog.go" --include "pkg/vfs/accesslog_test.go" --exclude ".accesslog" --exclude ".trash"'
            '--exclude ".accesslog" --exclude ".trash"'
            '--exclude ".accesslog" --exclude ".trash"'
          )
          for option in "${options[@]}"; do
            ./juicefs format $meta_url sync-test
            ./juicefs mount $meta_url ${{ steps.vars.outputs.MOUNT_POINT }} -d
            mv juicefs-source/* ${{ steps.vars.outputs.MOUNT_POINT }} 
            mv juicefs-source/.* ${{ steps.vars.outputs.MOUNT_POINT }} || true
            mkdir jfs_sync_dir
            ./juicefs sync  ${{ steps.vars.outputs.MOUNT_POINT }}/ jfs_sync_dir/ $option
            mkdir rsync_dir
            rsync -azh ${{ steps.vars.outputs.MOUNT_POINT }}/ rsync_dir/ $option
            diff -u -r jfs_sync_dir rsync_dir
          done
          ./juicefs umount ${{ steps.vars.outputs.MOUNT_POINT }}
          
      - name: Setup upterm session
        if: ${{ failure() }}
        uses: lhotari/action-upterm@v1
